@using System.Text.Json
@using FindMyMeds.Core.DTOs.Reports

@{
    ViewData["Title"] = "Reports Dashboard";

    var stats = (DashboardStatsDto)ViewBag.Stats;
    var meds = (IEnumerable<MedicationReportDto>)ViewBag.MedicationReport;
    var pharmacies = (IEnumerable<PharmacyActivityReportDto>)ViewBag.PharmacyReport;

    var pharmacyLabelsJson = JsonSerializer.Serialize(
        pharmacies.Select(p => p.PharmacyName)
    );

    var pharmacyDataJson = JsonSerializer.Serialize(
        pharmacies.Select(p => p.UpdatesCount)
    );
}


<div class="row text-center mb-5">
    <div class="col-md-3"><div class="stat-card bg-light"><div class="stat-icon">🏪</div><h6>Pharmacies</h6><h2>@stats.TotalPharmacies</h2></div></div>
    <div class="col-md-3"><div class="stat-card bg-light"><div class="stat-icon">💊</div><h6>Medications</h6><h2>@stats.TotalMedications</h2></div></div>
    <div class="col-md-3"><div class="stat-card bg-success text-white"><div class="stat-icon">✅</div><h6>Available</h6><h2>@stats.AvailableMedications</h2></div></div>
    <div class="col-md-3"><div class="stat-card bg-danger text-white"><div class="stat-icon">❌</div><h6>Out of Stock</h6><h2>@stats.OutOfStockMedications</h2></div></div>
</div>

<div class="row mb-5 align-items-stretch">
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-danger text-white">Medication Availability</div>
            <div class="card-body">
                <table class="table table-sm table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Medication</th>
                            <th>Available</th>
                            <th>Out</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in meds)
                        {
                            <tr>
                                <td>@m.MedicationName</td>
                                <td class="text-success">@m.AvailableCount</td>
                                <td class="text-danger">@m.OutOfStockCount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow h-100 d-flex justify-content-center align-items-center">
            <h5 class="mt-3">Availability Overview</h5>
            <div style="width:70%;">
                <canvas id="availabilityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5 align-items-stretch">
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-dark text-white">Pharmacy Activity</div>
            <div class="card-body">
                <table class="table table-sm table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Pharmacy</th>
                            <th>Medications Managed</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in pharmacies)
                        {
                            <tr>
                                <td>@p.PharmacyName</td>
                                <td>@p.UpdatesCount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow h-100 p-3">
            <h5 class="text-center mb-3">Pharmacy Contribution</h5>
            <canvas id="pharmacyChart"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            new Chart(document.getElementById('availabilityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Out of Stock'],
                    datasets: [{
                        data: [@stats.AvailableMedications, @stats.OutOfStockMedications],
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            new Chart(document.getElementById('pharmacyChart'), {
                type: 'bar',
                data: {
                    labels: @Html.Raw(pharmacyLabelsJson),
                    datasets: [{
                        label: 'Medications Managed',
                        data: @Html.Raw(pharmacyDataJson),
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    indexAxis: 'y',  
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        });
    </script>
}

<style>
    .stat-card {
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        transition: transform .3s ease;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .stat-icon {
        font-size: 32px;
        margin-bottom: 10px;
    }
</style>
